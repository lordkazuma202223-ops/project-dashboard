# 2026-02-13

## Issues & Fixes

### Agent Orchestrator - ReactFlow Import Error
- **Problem:** Page returned 500 error with `ReferenceError: ReactFlow is not defined`
- **Root Cause:** Missing `ReactFlow` in import statement from `@xyflow/react`
- **File:** `agent-orchestrator/src/components/WorkflowBuilder.tsx`
- **Original Import:**
  ```typescript
  import {
    Node,
    Edge,
    addEdge,
    Connection,
    useNodesState,
    useEdgesState,
    Background,
    Controls,
    MiniMap,
    NodeTypes,
  } from '@xyflow/react';
  ```
- **Fixed Import:**
  ```typescript
  import {
    Node,
    Edge,
    addEdge,
    Connection,
    useNodesState,
    useEdgesState,
    Background,
    Controls,
    MiniMap,
    NodeTypes,
    ReactFlow,  // ← Added this
  } from '@xyflow/react';
  ```
- **Symptoms:**
  - 500 Internal Server Error
  - ReactFlow component not defined error in logs
  - App wouldn't load
- **Solution:** Add missing `ReactFlow` to import statement
- **Time to Fix:** < 2 minutes
- **Prevention:**
  - When using React Flow components, always check imports
  - ReactFlow is the main wrapper component - always needed
  - Common mistake: only importing hooks/types but not the main component

### Agent Orchestrator - TypeScript NodeProps Type Error (Vercel Build)
- **Problem:** Vercel build failed with TypeScript error
- **Error Message:** `Type 'AgentNodeData' does not satisfy the constraint 'Node<Record<string, unknown>, string | undefined>'`
- **Root Cause:** `NodeProps<AgentNodeData>` has type constraint issues in React Flow 12
- **File:** `agent-orchestrator/src/components/nodes/AgentNode.tsx`
- **Original Code:**
  ```typescript
  export type AgentNodeData = {
    name: string;
    prompt: string;
    timeout: number;
    // ...
  };

  export function NodeComponent({ data, selected }: NodeProps<AgentNodeData>) {
    const [name, setName] = useState(data.name);
    // ...
  }
  ```
- **Fixed Code:**
  ```typescript
  export function NodeComponent({ data, selected }: NodeProps) {
    const nodeData = data as AgentNodeData;
    const [name, setName] = useState(nodeData.name);
    // ...
  }
  ```
- **Solution:** Use `NodeProps` without type parameter, then cast `data` to `AgentNodeData`
- **Time to Fix:** ~15 minutes
- **Prevention:**
  - React Flow 12 has stricter type constraints
  - Use type casting for custom node data when `NodeProps<T>` causes issues
  - Alternative: Use `@ts-ignore` or suppress the error with proper type assertion

### Agent Orchestrator - Gateway API "Failed to Fetch" Error
- **Problem:** API calls to OpenClaw Gateway were failing with "failed to fetch" error
- **Root Cause:** Two issues:
  1. Wrong Authorization header format (used `Bearer ${TOKEN}` instead of just token)
  2. Wrong health check endpoint (`/api/status` instead of `/api/session/status`)
- **File:** `agent-orchestrator/src/lib/gateway.ts`
- **Original Code:**
  ```typescript
  headers: {
    'Content-Type': 'application/json',
    ...(GATEWAY_TOKEN ? { 'Authorization': `Bearer ${GATEWAY_TOKEN}` } : {}),
  },

  // Health check:
  const response = await fetch(`${GATEWAY_URL}/api/status`, {
  ```
- **Fixed Code:**
  ```typescript
  headers: {
    'Content-Type': 'application/json',
    ...(GATEWAY_TOKEN ? { 'Authorization': GATEWAY_TOKEN } : {}),
  },

  // Health check:
  const response = await fetch(`${GATEWAY_URL}/api/session/status`, {
  ```
- **Solution:** Match the API pattern used in project-dashboard (which works correctly)
- **Discovery:** Checked project-dashboard's API routes to find the correct pattern
- **Time to Fix:** ~10 minutes
- **Prevention:**
  - Reference working examples when integrating with new APIs
  - OpenClaw Gateway uses direct token in Authorization header (not Bearer token)
  - Use correct endpoint paths: `/api/session/status`, `/api/cron-jobs`, etc.

### Agent Orchestrator - Environment Variable Not Loading in Client
- **Problem:** GATEWAY_TOKEN showing as "MISSING or EMPTY" in browser console
- **Root Cause:** Next.js environment variable scoping - `GATEWAY_TOKEN` not accessible in client code
- **File:** `agent-orchestrator/src/lib/gateway.ts`, Vercel environment variables
- **Original:** Used `process.env.GATEWAY_TOKEN` (server-side only)
- **Fixed:** Changed to `process.env.NEXT_PUBLIC_GATEWAY_TOKEN` (client accessible)
- **Solution:**
  - Changed code: `GATEWAY_TOKEN` → `NEXT_PUBLIC_GATEWAY_TOKEN`
  - Updated Vercel env var name to match
  - Next.js rule: `NEXT_PUBLIC_*` vars available in browser, others server-only
- **Time to Fix:** ~30 minutes
- **Prevention:**
  - Always use `NEXT_PUBLIC_` prefix for client-side environment variables
  - Next.js separates server and client env vars for security
  - Test environment variables in browser console (debug logging)

### Agent Orchestrator - Browser Extension Corrupting URLs
- **Problem:** API URLs being mangled with garbage characters, wrong domains, random suffixes
- **Symptoms:**
  - Expected: `https://unregularized-suboesophageal-ardith.ngrok-free.dev/api/sessions/spawn`
  - Actual: `unregularized-suboesophageal-ardith.ngrok-free.xn--dev%20%20gateway_token%20=...mq94c/api/sessions/spawn`
  - Error: `chrome-extension://jjkchpdmjjdmalgembblgafllbpcjlei/mcafee_wa_contentplg.js`
- **Root Cause:** McAfee WebAdvisor browser extension hijacking/modifying network requests
- **Solution:** Disable browser extension or use Incognito mode (extensions disabled)
- **Time to Diagnose:** ~20 minutes (debug logging revealed corruption)
- **Prevention:**
  - Test apps in Incognito to rule out extension interference
  - Be aware that security extensions can modify network traffic
  - If URLs look corrupted, check browser extensions

### Agent Orchestrator - Network-Level URL Corruption
- **Problem:** URLs being corrupted after console.log but during fetch() execution
- **Symptoms:**
  - Console logs correct URL: `https://unregularized-suboesophageal-ardith.ngrok-free.dev/api/sessions/spawn`
  - Fetch receives corrupted URL: `unregularized-suboesophageal-ardith.ngrok-free.xn--dev%20%20gateway_token%20=...`
  - Happens even in Incognito mode (no browser extensions)
  - TypeError with specific error pattern in fetch stack trace
- **Root Cause:** Network-level interference (proxy, firewall, antivirus, corporate security, ISP filtering)
  - Something intercepting/modifying fetch calls between JavaScript and actual network request
- **Solution Attempted:** Created `safeFetch` wrapper using URL objects to bypass string manipulation
  - Converts string URLs to URL objects before passing to fetch
  - Uses window.fetch directly with URL object
  - Bypasses string manipulation that might cause corruption
- **Time to Diagnose:** ~30 minutes (extensive debugging, multiple approaches)
- **Prevention:**
  - If URLs corrupted in Incognito, it's network-level interference
  - Try different networks (mobile data, public WiFi)
  - Consider using app only when at home network
  - Network security software can intercept and modify traffic

### Agent Orchestrator - Next.js Environment Variable Runtime Corruption
- **Problem:** GATEWAY_URL environment variable being corrupted during runtime with debug logging content embedded
- **Symptoms:**
  - Console logs correct URL: `https://unregularized-suboesophageal-ardith.ngrok-free.dev`
  - But URL passed to fetch contains embedded debug text: `https://unregularized-suboesophageal-ardith.ngrok-free.dev • GATEWAY_TOKEN = 07a5d8cd5744df1c744101dcecad78cec1c320aed8342ed9/api/sessions/spawn`
  - Error: "cannot be parsed as a URL"
- **Root Cause:** Debug logging somehow corrupting environment variables during Next.js runtime
- **Solution:** Removed ALL console.log statements and debug logging from code
- **Time to Fix:** ~60 minutes (multiple attempts with debug, safeFetch, final clean version)
- **Prevention:**
  - Avoid logging environment variables in production builds
  - Keep code simple and clean
  - If debugging needed, use server-side logging, not client console

## Notes
- ReactFlow import error was NOT a CSS issue - it was a JavaScript import issue
- The UI was completely broken (500 error), not just styling issues
- React Flow requires explicit import of the `ReactFlow` component
- TypeScript errors during build can be subtle - always test build before deploying
- API integration issues: Always check working examples when in doubt
- OpenClaw Gateway API uses direct token authorization, not Bearer token
- **Network-Level URL Corruption:** Both browser extension interference AND Next.js runtime environment variable corruption occurred
- **Final Solution:** Removed all debug logging and simplified code to eliminate corruption sources
- **Important:** When you're away from laptop, consider using local dev server (localhost:3000) instead of deployed site
